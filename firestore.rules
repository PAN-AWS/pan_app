rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }

    function isChatMember(chatId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && get(/databases/$(database)/documents/chats/$(chatId)).data.members.hasAny([request.auth.uid]);
    }

    function isGroupMember(groupId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/groups/$(groupId))
        && get(/databases/$(database)/documents/groups/$(groupId)).data.members.hasAny([request.auth.uid]);
    }

    function isGroupAdmin(groupId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/groups/$(groupId))
        && get(/databases/$(database)/documents/groups/$(groupId)).data.admins.hasAny([request.auth.uid]);
    }

    function validPublicProfile() {
      return request.resource.data.keys().hasOnly([
        'displayName',
        'avatarPath',
        'role',
        'company',
        'bio',
        'provinceCode',
        'provinceName',
        'products',
        'createdAt',
        'updatedAt'
      ])
      && request.resource.data.displayName is string
      && request.resource.data.displayName.size() > 0
      && (!('avatarPath' in request.resource.data) || request.resource.data.avatarPath is string)
      && (!('role' in request.resource.data) || request.resource.data.role is string)
      && (!('company' in request.resource.data) || request.resource.data.company is string)
      && (!('bio' in request.resource.data) || request.resource.data.bio is string)
      && (!('provinceCode' in request.resource.data) || request.resource.data.provinceCode is string)
      && (!('provinceName' in request.resource.data) || request.resource.data.provinceName is string)
      && (!('products' in request.resource.data) || request.resource.data.products is list)
      && (!('createdAt' in request.resource.data) || request.resource.data.createdAt is timestamp)
      && (!('updatedAt' in request.resource.data) || request.resource.data.updatedAt is timestamp);
    }

    function validMessage() {
      return request.resource.data.keys().hasOnly([
        'senderId',
        'type',
        'text',
        'mediaPath',
        'thumbPath',
        'contentType',
        'sizeBytes',
        'createdAt'
      ])
      && request.resource.data.senderId == request.auth.uid
      && request.resource.data.type in ['text', 'image', 'video']
      && request.resource.data.createdAt is timestamp
      && (
        (request.resource.data.type == 'text'
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && !('mediaPath' in request.resource.data))
        ||
        (request.resource.data.type in ['image', 'video']
          && request.resource.data.mediaPath is string
          && request.resource.data.mediaPath.size() > 0
          && (!('text' in request.resource.data)))
      )
      && (!('thumbPath' in request.resource.data) || request.resource.data.thumbPath is string)
      && (!('contentType' in request.resource.data) || request.resource.data.contentType is string)
      && (!('sizeBytes' in request.resource.data) || request.resource.data.sizeBytes is int);
    }

    function validDmCreate() {
      return request.resource.data.keys().hasOnly([
        'type',
        'members',
        'createdBy',
        'createdAt',
        'lastMessageAt',
        'lastMessageText',
        'lastMessageType',
        'lastMessageSenderId'
      ])
      && request.resource.data.type == 'dm'
      && request.resource.id.matches('dm_.*')
      && request.resource.data.members is list
      && request.resource.data.members.size() == 2
      && request.resource.data.members.hasAll([request.auth.uid])
      && request.resource.data.createdBy == request.auth.uid
      && request.resource.data.createdAt is timestamp
      && (!('lastMessageAt' in request.resource.data) || request.resource.data.lastMessageAt is timestamp);
    }

    function validDmUpdate() {
      return request.resource.data.type == resource.data.type
        && request.resource.data.members == resource.data.members
        && request.resource.data.createdBy == resource.data.createdBy
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'lastMessageAt',
          'lastMessageText',
          'lastMessageType',
          'lastMessageSenderId'
        ]);
    }

    function validGroupCreate() {
      return request.resource.data.keys().hasOnly([
        'type',
        'name',
        'members',
        'admins',
        'createdBy',
        'createdAt',
        'lastMessageAt',
        'lastMessageText',
        'lastMessageType',
        'lastMessageSenderId'
      ])
      && request.resource.data.type == 'group'
      && request.resource.data.name is string
      && request.resource.data.members is list
      && request.resource.data.members.hasAll([request.auth.uid])
      && request.resource.data.admins is list
      && request.resource.data.admins.hasAll([request.auth.uid])
      && request.resource.data.createdBy == request.auth.uid
      && request.resource.data.createdAt is timestamp
      && (!('lastMessageAt' in request.resource.data) || request.resource.data.lastMessageAt is timestamp);
    }

    function validGroupMessageUpdate() {
      return request.resource.data.type == resource.data.type
        && request.resource.data.name == resource.data.name
        && request.resource.data.members == resource.data.members
        && request.resource.data.admins == resource.data.admins
        && request.resource.data.createdBy == resource.data.createdBy
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'lastMessageAt',
          'lastMessageText',
          'lastMessageType',
          'lastMessageSenderId'
        ]);
    }

    function validGroupAdminUpdate() {
      return request.resource.data.type == resource.data.type
        && request.resource.data.createdBy == resource.data.createdBy
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'name',
          'members',
          'admins'
        ]);
    }

    function selfJoinGroup() {
      return request.resource.data.members is list
        && resource.data.members is list
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['members'])
        && !resource.data.members.hasAny([request.auth.uid])
        && request.resource.data.members.hasAny([request.auth.uid])
        && request.resource.data.members.size() == resource.data.members.size() + 1;
    }

    match /public_profiles/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isOwner(userId) && validPublicProfile();
      allow delete: if false;
    }

    match /users_private/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /chats/{chatId} {
      allow create: if isSignedIn() && validDmCreate();
      allow read: if isChatMember(chatId);
      allow update: if isChatMember(chatId) && validDmUpdate();
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isChatMember(chatId);
        allow create: if isChatMember(chatId) && validMessage();
        allow update, delete: if false;
      }
    }

    match /groups/{groupId} {
      allow create: if isSignedIn() && validGroupCreate();
      allow read: if isGroupMember(groupId);
      allow update: if (isGroupMember(groupId) && validGroupMessageUpdate())
        || (isGroupAdmin(groupId) && validGroupAdminUpdate())
        || (isSignedIn() && selfJoinGroup());
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isGroupMember(groupId);
        allow create: if isGroupMember(groupId) && validMessage();
        allow update, delete: if false;
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
