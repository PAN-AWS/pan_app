rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId; }

    function chatDoc(chatId) {
      return get(/databases/$(database)/documents/chats/$(chatId));
    }

    function groupDoc(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId));
    }

    function chatHasMember(chatId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && chatDoc(chatId).data.members is list
        && chatDoc(chatId).data.members.hasAny([request.auth.uid]);
    }

    function groupHasMember(groupId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/groups/$(groupId))
        && groupDoc(groupId).data.members is list
        && groupDoc(groupId).data.members.hasAny([request.auth.uid]);
    }

    // Consente self-join: l’utente può aggiungersi SOLO una volta e SOLO al campo members
    function selfJoinMembersOnly() {
      return isSignedIn()
        && resource.data.members is list
        && request.resource.data.members is list
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['members'])
        && !(resource.data.members.hasAny([request.auth.uid]))
        && request.resource.data.members.hasAny([request.auth.uid])
        && request.resource.data.members.size() == resource.data.members.size() + 1;
    }

    // Profili pubblici
    match /public_profiles/{userId} {
      allow read: if true;
      allow create, update, delete: if isSelf(userId);
    }
    match /public_profiles/{userId}/{document=**} {
      allow read: if true;
      allow write: if isSelf(userId);
    }

    // Utente (doc principale)
    match /users/{userId} {
      allow read, create, update, delete: if isSelf(userId);
    }
    // Subcollection sotto users (se usate dal codice: users/{uid}/profile ecc.)
    match /users/{userId}/{document=**} {
      allow read, write: if isSelf(userId);
    }

    // Chat 1:1
    match /chats/{chatId} {
      allow create: if isSignedIn()
        && request.resource.data.members is list
        && request.auth.uid in request.resource.data.members;

      allow read: if isSignedIn()
        && resource.data.members is list
        && resource.data.members.hasAny([request.auth.uid]);

      allow update, delete: if isSignedIn()
        && resource.data.members is list
        && resource.data.members.hasAny([request.auth.uid]);

      match /messages/{messageId} {
        allow read: if chatHasMember(chatId);
        allow create: if chatHasMember(chatId)
          && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    // Gruppi
    match /groups/{groupId} {
      allow create: if isSignedIn()
        && request.resource.data.members is list
        && request.auth.uid in request.resource.data.members;

      allow read: if groupHasMember(groupId);
      allow update: if groupHasMember(groupId) || selfJoinMembersOnly();
      allow delete: if groupHasMember(groupId);

      match /messages/{messageId} {
        allow read: if groupHasMember(groupId);
        allow create: if groupHasMember(groupId)
          && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if false;
      }
    }
  }
}
